<!DOCTYPE html>
<html>
<head>
    <title>Journey Insights Test</title>
    <style>
        body { font-family: system-ui; margin: 2rem; }
        .result { margin: 1rem 0; padding: 0.5rem; border-radius: 4px; }
        .pass { background: #d4edda; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { margin: 0.5rem; padding: 0.5rem 1rem; cursor: pointer; }
        .test-data { background: #f8f9fa; padding: 1rem; border-radius: 4px; margin: 1rem 0; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>Journey Insights Aggregation & Reporting Test</h1>
    
    <div id="results"></div>
    <button onclick="runTests()">Run Tests</button>
    <button onclick="simulateJourney()">Simulate Journey</button>
    <button onclick="showJourneyInsights()">Show Journey Data</button>
    <button onclick="showAggregatedData()">Show Aggregated Analytics</button>
    <button onclick="clearResults()">Clear</button>

    <script src="assets/js/privacy-analytics.js"></script>
    <script>
        function addResult(test, passed, message = '') {
            const div = document.createElement('div');
            div.className = `result ${passed ? 'pass' : 'fail'}`;
            div.textContent = `${passed ? '✓' : '✗'} ${test}: ${message}`;
            document.getElementById('results').appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function runTests() {
            clearResults();
            
            // Test 1: Journey data export exists
            addResult('Journey Data Export', 
                typeof window.exportJourneyData === 'function',
                'exportJourneyData method available');
            
            // Test 2: Aggregated data includes journey information
            const aggregatedData = window.PrivacyAnalytics.getAggregatedData();
            addResult('Journey in Aggregated Data',
                aggregatedData && aggregatedData.journey,
                aggregatedData ? 'Journey data included in analytics' : 'No journey data');
            
            // Test 3: Journey data completeness
            const journeyData = window.exportJourneyData();
            const expectedFields = ['navs', 'searches', 'filters', 'duration', 'referrers', 'entries', 'exits'];
            const hasAllFields = expectedFields.every(field => journeyData.hasOwnProperty(field));
            addResult('Journey Data Completeness',
                hasAllFields,
                hasAllFields ? 'All expected fields present' : 'Missing fields: ' + expectedFields.filter(f => !journeyData.hasOwnProperty(f)).join(', '));
            
            // Test 4: Privacy compliance in journey data
            addResult('Privacy Compliance',
                journeyData.privacy && journeyData.privacy.anon === true && journeyData.privacy.cookies === false,
                'Journey data includes privacy compliance info');
            
            // Test 5: User flow analysis availability
            addResult('User Flow Analysis',
                typeof window.analyzeUserFlow === 'function',
                'analyzeUserFlow method available');
        }

        function simulateJourney() {
            clearResults();
            addResult('Journey Simulation', true, 'Starting comprehensive journey simulation...');
            
            // Simulate various user interactions over time
            setTimeout(() => {
                // Simulate search behavior
                if (window.trackSearchBehavior) {
                    window.trackSearchBehavior('gnome apps', 5);
                    addResult('Search Simulation', true, 'Tracked search: "gnome apps"');
                }
            }, 500);
            
            setTimeout(() => {
                // Simulate navigation
                if (window.trackNavigation) {
                    window.trackNavigation('/', '/apps/example/', 'click');
                    addResult('Navigation Simulation', true, 'Tracked navigation: / → /apps/example/');
                }
            }, 1000);
            
            setTimeout(() => {
                // Simulate another search with refinement
                if (window.trackSearchBehavior) {
                    window.trackSearchBehavior('gnome text editor', 3);
                    addResult('Search Refinement Simulation', true, 'Tracked refined search');
                }
            }, 1500);
            
            setTimeout(() => {
                // Check journey data after simulation
                const journeyData = window.exportJourneyData();
                const aggregatedData = window.PrivacyAnalytics.getAggregatedData();
                
                addResult('Post-Simulation Journey Check',
                    journeyData.searches > 0 || journeyData.navs > 0,
                    `Searches: ${journeyData.searches}, Navigations: ${journeyData.navs}, Duration: ${Math.floor(journeyData.duration / 1000)}s`);
                
                if (aggregatedData.journey) {
                    addResult('Aggregated Journey Data',
                        true,
                        `Journey data in aggregated analytics: ${aggregatedData.journey.searches} searches, ${aggregatedData.journey.navigations} navigations`);
                }
            }, 2000);
        }

        function showJourneyInsights() {
            const journeyData = window.exportJourneyData();
            if (journeyData) {
                const div = document.createElement('div');
                div.className = 'test-data';
                div.innerHTML = `
                    <h3>Journey Insights Data</h3>
                    <pre>${JSON.stringify(journeyData, null, 2)}</pre>
                `;
                document.getElementById('results').appendChild(div);
            } else {
                addResult('Journey Insights', false, 'No journey data available');
            }
        }

        function showAggregatedData() {
            const aggregatedData = window.PrivacyAnalytics.getAggregatedData();
            if (aggregatedData && aggregatedData.journey) {
                const div = document.createElement('div');
                div.className = 'test-data';
                div.innerHTML = `
                    <h3>Journey Data in Aggregated Analytics</h3>
                    <pre>${JSON.stringify(aggregatedData.journey, null, 2)}</pre>
                    <h4>Complete Aggregated Data Structure</h4>
                    <pre>${JSON.stringify(aggregatedData, null, 2)}</pre>
                `;
                document.getElementById('results').appendChild(div);
            } else {
                addResult('Aggregated Data', false, 'No journey data in aggregated analytics');
            }
        }

        // Show initial data on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('Page Load', true, 'Analytics initialized, ready for journey tracking');
            }, 1000);
        });
    </script>
</body>
</html>