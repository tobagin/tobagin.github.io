<!DOCTYPE html>
<html>
<head>
    <title>Referrer Classification Test</title>
    <style>
        body { font-family: system-ui; margin: 2rem; }
        .result { margin: 1rem 0; padding: 0.5rem; border-radius: 4px; }
        .pass { background: #d4edda; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { margin: 0.5rem; padding: 0.5rem 1rem; cursor: pointer; }
        .test-section { margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>Referrer Classification Test</h1>
    
    <div id="results"></div>
    <button onclick="runTests()">Run Tests</button>
    <button onclick="testClassifications()">Test Classifications</button>
    <button onclick="showReferrerData()">Show Referrer Data</button>
    <button onclick="clearResults()">Clear</button>

    <script src="assets/js/privacy-analytics.js"></script>
    <script>
        function addResult(test, passed, message = '') {
            const div = document.createElement('div');
            div.className = `result ${passed ? 'pass' : 'fail'}`;
            div.textContent = `${passed ? '✓' : '✗'} ${test}: ${message}`;
            document.getElementById('results').appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function runTests() {
            clearResults();
            
            // Test 1: Referrer classification method exists
            addResult('Referrer Classification Available', 
                typeof window.PrivacyAnalytics.classifyReferrer === 'function',
                'classifyReferrer method exists');
            
            // Test 2: Initial referrer tracking
            const journeyData = window.exportJourneyData();
            addResult('Initial Referrer Tracking',
                journeyData && typeof journeyData.referrers === 'object',
                journeyData ? `${Object.keys(journeyData.referrers).length} referrer types tracked` : 'No data');
            
            // Test 3: Referrer data in aggregated analytics
            const aggregatedData = window.PrivacyAnalytics.getAggregatedData();
            addResult('Referrers in Aggregated Data',
                aggregatedData && aggregatedData.journey && aggregatedData.journey.referrers,
                aggregatedData ? 'Referrer data included in journey analytics' : 'No referrer data');
        }

        function testClassifications() {
            clearResults();
            addResult('Classification Tests', true, 'Testing referrer classification logic...');
            
            // Test different referrer types
            const testCases = [
                { url: '', expected: 'direct' },
                { url: 'https://google.com/search?q=test', expected: 'search' },
                { url: 'https://www.bing.com/search?q=gnome', expected: 'search' },
                { url: 'https://duckduckgo.com/?q=apps', expected: 'search' },
                { url: 'https://twitter.com/someuser', expected: 'social' },
                { url: 'https://facebook.com/page', expected: 'social' },
                { url: 'https://reddit.com/r/linux', expected: 'social' },
                { url: 'https://github.com/user/repo', expected: 'tech' },
                { url: 'https://flathub.org/apps/details/app', expected: 'tech' },
                { url: 'https://example.com/page', expected: 'external' },
                { url: 'invalid-url', expected: 'unknown' }
            ];
            
            testCases.forEach(testCase => {
                try {
                    const result = window.PrivacyAnalytics.classifyReferrer(testCase.url);
                    const passed = result.type === testCase.expected;
                    addResult(`${testCase.expected.toUpperCase()} Classification`, 
                        passed,
                        `${testCase.url || 'empty'} → ${result.type} (${result.domain || 'no domain'})`);
                } catch (error) {
                    addResult(`${testCase.expected.toUpperCase()} Classification`, 
                        false,
                        `Error: ${error.message}`);
                }
            });
        }

        function showReferrerData() {
            const journeyData = window.exportJourneyData();
            if (journeyData && journeyData.referrers) {
                const div = document.createElement('div');
                div.className = 'result pass';
                div.innerHTML = `
                    <strong>Current Referrer Data:</strong><br>
                    <pre>${JSON.stringify(journeyData.referrers, null, 2)}</pre>
                    <br><strong>Total Referrer Types:</strong> ${Object.keys(journeyData.referrers).length}
                `;
                document.getElementById('results').appendChild(div);
            } else {
                addResult('Referrer Data', false, 'No referrer data available');
            }
        }

        // Simulate some referrer data by manually calling the classification
        function simulateReferrers() {
            // This would normally be called automatically by the analytics system
            // We can show the current referrer data that was captured on page load
            const currentReferrer = document.referrer;
            if (currentReferrer) {
                const classification = window.PrivacyAnalytics.classifyReferrer(currentReferrer);
                addResult('Current Page Referrer', 
                    true, 
                    `${currentReferrer} classified as: ${classification.type} (${classification.domain})`);
            } else {
                addResult('Current Page Referrer', 
                    true, 
                    'Direct navigation (no referrer)');
            }
        }

        // Auto-run simulation on page load
        window.addEventListener('load', () => {
            setTimeout(simulateReferrers, 1000);
        });
    </script>
</body>
</html>